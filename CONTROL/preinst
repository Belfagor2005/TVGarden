#!/bin/sh
# preinst script for TV Garden Plugin
# This script runs BEFORE package files are unpacked

echo "=== TV Garden Plugin Pre-Installation ==="

# Verifica che siamo su Enigma2
if [ ! -f /usr/bin/enigma2 ]; then
    echo "ERROR: This plugin requires Enigma2!"
    exit 1
fi

# Verifica Python (necessario per il plugin)
if ! command -v python3 >/dev/null 2>&1; then
    echo "ERROR: Python3 is required but not found!"
    exit 1
fi

# Verifica dipendenze minime
if ! opkg list-installed | grep -q "gstreamer"; then
    echo "WARNING: GStreamer not found. Player may not work correctly."
fi

# Crea directory necessarie se non esistono
TVGARDEN_DIR="/usr/lib/enigma2/python/Plugins/Extensions/TVGarden"
if [ ! -d "$TVGARDEN_DIR" ]; then
    mkdir -p "$TVGARDEN_DIR"
    echo "Created TVGarden directory: $TVGARDEN_DIR"
fi

# Backup della configurazione se esiste
CONFIG_DIR="/etc/enigma2/tvgarden"
if [ -d "$CONFIG_DIR" ]; then
    BACKUP_DIR="/tmp/tvgarden_backup_$(date +%Y%m%d_%H%M%S)"
    cp -r "$CONFIG_DIR" "$BACKUP_DIR"
    echo "Configuration backed up to: $BACKUP_DIR"
fi

echo "Pre-installation checks completed successfully."
exit 0